@using ChatApp.Models

<div class="p-3">
    @if (IsAddingParticipants)
    {
        <h4>Add users</h4>
        <p>Add users to the conversation:</p>
    }
    else
    {
        <h4>New Chat</h4>
        <p>Select users to start a conversation with:</p>
    }

    <div class="list-group" style="max-width: 400px; max-height: 400px; overflow-y: auto;">
        @foreach (var user in AllUsers)
        {
            var isSelected = SelectedUsers.Contains(user.Key);
            var isOnline = OnlineUsers.ContainsKey(user.Key);

            <button class="list-group-item list-group-item-action @(isSelected ? "active" : "")"
            @onclick="() => OnToggleUser.InvokeAsync(user.Key)">
                <div class="d-flex align-items-center">
                    <input class="form-check-input darker-border-checkbox me-2" type="checkbox" checked="@isSelected"
                        readonly />
                    <span class="status-dot @(isOnline ? "online" : "offline")"
                        title="@(isOnline ? "Online" : "Offline")"></span>
                    <div class="ms-1 d-flex flex-column text-start">
                        <span>@user.Value.UserName</span>
                        @if (user.Value.Roles != null && user.Value.Roles.Any())
                        {
                            <span class="opacity-75" style="font-size: 0.75rem;">@string.Join(", ", user.Value.Roles)</span>
                        }
                    </div>
                </div>
            </button>
        }
        @if (!AllUsers.Any())
        {
            <div class="text-muted">No other users found.</div>
        }
    </div>
</div>

<ChatInput ButtonText="Start" Placeholder="Type a message to start chat..." IsConnected="@IsConnected" OnSend="OnStart"
    OnFileChange="OnFileUpload" Class="mt-auto">
    @if (SelectedUsers.Count > 0)
    {
        <div class="text-muted small mt-1">Starting chat with: @SelectedUsers.Count users</div>
    }
</ChatInput>

@code {
    [Parameter] public Dictionary<string, UserDto> AllUsers { get; set; } = new();
    [Parameter] public Dictionary<string, string> OnlineUsers { get; set; } = new();
    [Parameter] public HashSet<string> SelectedUsers { get; set; } = new();
    [Parameter] public bool IsAddingParticipants { get; set; }
    [Parameter] public bool IsConnected { get; set; }
    [Parameter] public EventCallback<string> OnToggleUser { get; set; }
    [Parameter] public EventCallback<string> OnStart { get; set; }
    [Parameter] public EventCallback<InputFileChangeEventArgs> OnFileUpload { get; set; }
}
